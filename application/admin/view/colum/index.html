<!DOCTYPE html>
<html class="x-admin-sm">
  <head>
    {include file="public/head" /}
    <!-- <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script> -->
    <script type="text/javascript" src="__STATIC__/admin/js/jquery-3.6.4.min.js"></script>
  </head>

  <body>
    <div class="x-nav">
      <span class="layui-breadcrumb">
        <a href="">首页</a>
        <a href="">演示</a>
        <a>
          <cite>导航元素</cite></a>
      </span>
      <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right"
        onclick="location.reload()" title="刷新">
        <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
      </a>
    </div>
    <div class="layui-fluid">
      <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
          <div class="layui-card">
            <div class="layui-card-body ">
              <form class="layui-form layui-col-space5" style="display: none;">
                <div class="layui-input-inline layui-show-xs-block">
                  <input class="layui-input" placeholder="分类名" name="cate_name">
                </div>
                <div class="layui-input-inline layui-show-xs-block">
                  <button class="layui-btn" lay-submit="" lay-filter="sreach"><i
                      class="layui-icon"></i>增加
                  </button>
                </div>
              </form>
              <hr>
              <blockquote class="layui-elem-quote">每个tr 上有两个属性 cate-id='1' 当前分类id fid='0' 父级id ,顶级分类为
                0，有子分类的前面加收缩图标<i class="layui-icon x-show" status='true'>&#xe623;</i></blockquote>
            </div>
            <div class="layui-card-header">
              <button class="layui-btn layui-btn-danger" onclick="delAll()">
                <i class="layui-icon"></i>批量删除
              </button>
              <button class="layui-btn" onclick="xadmin.open('添加栏目','{:url('add')}',600,400)"><i class="layui-icon"></i>添加栏目</button>
              <button class="layui-btn layui-btn-normal" onclick="sort()">
                <i class="layui-icon">&#xe631;</i>
                排序修改
              </button>
            </div>
            <div class="layui-card-body ">
              <table class="layui-table layui-form">
                <thead>
                  <tr>
                    <th width="20">
                      <!-- <input type="checkbox" name="" lay-skin="primary"> -->
                      <input class="check" type="checkbox" lay-filter="checkall" name="" lay-skin="primary">
                    </th>
                    <th width="70">ID</th>
                    <th>栏目名</th>
                    <th width="50">排序</th>
                    <th width="80">状态</th>
                    <th width="250">操作</th>
                </thead>   
                <tbody class="x-cate">
                  {volist name="data" id="dat"}
                  <tr cate-id='{$dat.id}' fid='{$dat.pid}' id="tr{$dat.id}">
                    <td>
                      <input class="check" lay-filter="{$dat.pid}" type="checkbox" name="id" value="{$dat.id}" lay-skin="primary">
                    </td>
                    <td>{$dat.id}</td>
                    <td>
                      <i class="layui-icon x-show" status='true'>&#xe623;</i>
                      <?php echo str_repeat('--',$dat['level']); ?>{$dat.name}
                    </td>
                    <td><input type="text" id="{$dat.id}" class="layui-input x-sort" name="sort" value="{$dat.sort}"></td>
                    <td>
                      
                      {if condition="$dat.status eq 1"}
                        <a onclick="member_stop(this,{$dat.id},{$dat.status})" href="javascript:;"  title="停用">
                          <input type="checkbox" name="status" lay-text="开启|停用" lay-skin="switch" checked>
                        </a>
                      {else /}
                        <a onclick="member_stop(this,{$dat.id},{$dat.status})" href="javascript:;"  title="启用">
                            <input type="checkbox" name="status" lay-text="开启|停用" lay-skin="switch">
                        </a>
                      {/if}
                    </td>
                    <td class="td-manage">
                      <button class="layui-btn layui-btn layui-btn-xs"
                        onclick="xadmin.open('编辑','{:url('edit',array('id'=>$dat.id))}',600,400)">
                        <i class="layui-icon">&#xe642;</i>编辑</button>
                      <button class="layui-btn layui-btn-warm layui-btn-xs" onclick="xadmin.open('添加栏目','{:url('add_zhi',array('id'=>$dat.id))}',600,400)">
                        <i class="layui-icon">&#xe642;</i>添加子栏目</button>
                      <button class="layui-btn-danger layui-btn layui-btn-xs"
                        onclick="member_del(this,{$dat.id})" href="javascript:;">
                        <i class="layui-icon">&#xe640;</i>删除
                      </button>
                    </td>
                  </tr>
                  {/volist}
                </tbody>
              </table>
            </div>
            <!-- <div class="layui-card-body ">
              <div class="page">
                <div>
                  <a class="prev" href="">&lt;&lt;</a>
                  <a class="num" href="">1</a>
                  <span class="current">2</span>
                  <a class="num" href="">3</a>
                  <a class="num" href="">489</a>
                  <a class="next" href="">&gt;&gt;</a>
                </div>
              </div>
            </div> -->
          </div>
        </div>
      </div>
    </div>
    <script>

      layui.use(['form'], function() {
        form = layui.form;

        // 监听全选
        form.on('checkbox(checkall)', function(data){
          if(data.elem.checked){
            // $('tbody input.check').prop('checked',true);
            $('tbody input[type="checkbox"]').prop('checked',true);
          }else{
            $('tbody input.check').prop('checked',false);
          }
          form.render('checkbox');
        });

        //批量修改，取消顶级分类及该顶级分类下的子分类
        form.on('checkbox(0)', function(data){
          cateIds = [];
          var cateId = $(this).parents('tr').attr("cate-id");
          getCateId(cateId);
          // alert(cateIds);
          // alert($(this).get(0).checked);
          if ($(this).get(0).checked) {
            for (var i in cateIds) {
              $("tbody tr[cate-id=" + cateIds[i] + "]").find('td').find('.layui-form-checkbox').addClass("layui-form-checked");
              $("tbody tr[cate-id=" + cateIds[i] + "]").find('td').find('input[type="checkbox"').prop('checked',true);
              // alert(cateIds[i]);
            }
          }else {
            for (var i in cateIds) {
              $("tbody tr[cate-id=" + cateIds[i] + "]").find('td').find('.layui-form-checkbox').removeClass("layui-form-checked");
              $("tbody tr[cate-id=" + cateIds[i] + "]").find('td').find('input[type="checkbox"').prop('checked',false);
              // alert(cateIds[i]);
            }
          }
          // for (var i in cateIds) {
          //   $("tbody tr[cate-id=" + cateIds[i] + "]").find('td').find('.layui-form-checkbox').removeClass("layui-form-checked");
          //   $("tbody tr[cate-id=" + cateIds[i] + "]").find('td').find('input[type="checkbox"').prop('checked',false);
          //   // alert(cateIds[i]);
          // }
        });

      });
      

      /*用户-停用*/
      function member_stop(obj,id,val){
          // alert(len);
          cateIds = [];
          cateId = $(obj).parents('tr').attr('cate-id');
          getCateId(cateId);
          var len = cateIds.length;
          if (val) {
            layer.confirm('确认要停用吗？',function(index){
              $.post("{:url("ajax_status")}",{id:id,status:0},function(data){
                 // alert(data);
                if (data==1) {
                    if (len>0) {
                      for (var i in cateIds) {
                        $("tbody tr[cate-id=" + cateIds[i] + "]").find('a').attr('onclick','member_stop(this,'+cateIds[i]+',0)').find('.layui-unselect').removeClass('layui-form-onswitch').find('em').html('停用');
                      }
                      $(obj).find('.layui-unselect').removeClass('layui-form-onswitch').find('em').html('停用');
                    }else {
                      $(obj).find('.layui-unselect').removeClass('layui-form-onswitch').find('em').html('停用');
                    }

                    //发异步把用户状态进行更改
                    $(obj).attr('title','停用')
                    $(obj).attr('onclick','member_stop(this,'+id+',0)');
                    // $(obj).parents("tr").find(".td-status").find('span').addClass('layui-btn-disabled').html('已停用');
                    layer.msg('已停用!',{icon: 5,time:1000});
                }else {
                    layer.alert('停用失败!!!');
                }
              })
            },function(){
              $(obj).find('.layui-unselect').addClass('layui-form-onswitch').find('em').html('启用');
              layer.alert('启用失败!!!');
            });
          }else {
            layer.confirm('确认要启用吗？',function(index){
              $.post("{:url("ajax_status")}",{id:id,status:1},function(data){
                  // alert(cateIds);
                  if (data==1) {
                      if (len>0) {
                        for (var i in cateIds) {
                          $("tbody tr[cate-id=" + cateIds[i] + "]").find('a').attr('onclick','member_stop(this,'+cateIds[i]+',1)').find('.layui-unselect').addClass('layui-form-onswitch').find('em').html('启用');
                        }
                        $(obj).find('.layui-unselect').addClass('layui-form-onswitch').find('em').html('启用');
                      }else {
                        $(obj).find('.layui-unselect').addClass('layui-form-onswitch').find('em').html('启用');
                      }
                      $(obj).attr('title','启用')
                      $(obj).attr('onclick','member_stop(this,'+id+',1)');
                      // $(obj).parents("tr").find(".td-status").find('span').removeClass('layui-btn-disabled').html('已启用');
                      layer.msg('已启用!',{icon: 6,time:1000});
                  }else {
                      layer.alert('启用失败!!!');
                  }
              })
            },function(){
              $(obj).find('.layui-unselect').removeClass('layui-form-onswitch').find('em').html('停用');
              layer.alert('启用失败!!!');
            })
          }
      }

      //排序
      function sort() {
          // alert($(obj).val());
          // num=$(obj).val();
          var ids_sorts = [];
          // 获取选中的id 
          $('.layui-input.x-sort').each(function(index, el) {
              // if($(this).prop('checked')){
              //   if ($(this).val()!=0) {
              //     ids.push($(this).val())
              //   }
              // }
              if ($(this).attr('id')!=0 && $(this).attr('id')!='' && $(this).val()!='') {
                ids_sorts.push($(this).attr('id') + "--" + $(this).val());
              }
          });
          str=ids_sorts.join(',',ids_sorts);
          $.post('{:url("sort")}', {str:str}, function(data) {
              if (data==1) {
                  // $(obj).val(num);
                  layer.alert("排序修改成功！", {
                      icon: 6
                  },
                  function() {
                      // // 获得frame索引
                      // var index = parent.layer.getFrameIndex(window.name);
                      // //关闭当前frame
                      // parent.layer.close(index);
                      parent.location.reload();
                  });
              }
          });
      }

      /*用户-删除*/
      // function member_del(obj, id) {
      //   layer.confirm('确认要删除吗？', function(index) {
      //     //发异步删除数据
      //     $(obj).parents("tr").remove();
      //     layer.msg('已删除!', {
      //       icon: 1,
      //       time: 1000
      //     });
      //   });
      // }
      function member_del(obj,id){
        layer.confirm('确认要删除吗？',function(index){
          $.post('{:url('del')}',{id:id},function(data){
            if (data==1) {
                  //发异步删除数据
                  $(obj).parents("tr").remove();
                  layer.msg('已删除!',{icon:1,time:1000});
              
            }
          })
        });
      }

      //批量删除
      function delAll (argument) {
        var ids = [];
        // 获取选中的id 
        $('tbody input.check').each(function(index, el) {
            if($(this).prop('checked')){
               ids.push($(this).val())
            }
        });
        str=ids.join(',',ids);
        // alert(str);
        layer.confirm('确认要删除吗？'+ids.toString(),function(index){
          $.post("{:url('ajax_delAll')}",{id:str},function(data){
            if (data==ids.length) {
                //捉到所有被选中的，发异步进行删除
                layer.msg('删除成功', {icon: 1});
                $(".layui-form-checked").not('.header').parents('tr').remove();
            }else {
                layer.msg('删除失败!!!');
            }
          })
            // //捉到所有被选中的，发异步进行删除
            // layer.msg('删除成功', {icon: 1});
            // $(".layui-form-checked").not('.header').parents('tr').remove();
        });
      }

      // 分类展开收起的分类的逻辑
      // 
      $(function() {
        $("tbody.x-cate tr[fid!='0']").hide();
        // 栏目多级显示效果
        $('.x-show').click(function() {
          if ($(this).attr('status') == 'true') {
            $(this).html('&#xe625;');
            $(this).attr('status', 'false');
            cateId = $(this).parents('tr').attr('cate-id');
            $("tbody tr[fid=" + cateId + "]").show();
          } else {
            cateIds = [];
            $(this).html('&#xe623;');
            $(this).attr('status', 'true');
            cateId = $(this).parents('tr').attr('cate-id');
            getCateId(cateId);
            // console.log(cateIds);
            // $("tbody tr[fid=" + cateId + "]").hide();
            for (var i in cateIds) {
              $("tbody tr[cate-id=" + cateIds[i] + "]").hide().find('.x-show').html('&#xe623;')
                .attr('status', 'true');
            }
          }
        })
      })

      var cateIds = [];
      function getCateId(cateId) {
        $("tbody tr[fid="+cateId+"]").each(function(index, el) {
            id = $(el).attr('cate-id');
            cateIds.push(id);
            getCateId(id);
        });
      }
    </script>
  </body>
</html>